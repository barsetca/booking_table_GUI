# Система бронирования столов в ресторане

GUI приложение для управления бронированием столов в ресторане. Система позволяет управлять пользователями, столами и бронированиями через удобный графический интерфейс на базе tkinter.

[![Python](https://img.shields.io/badge/Python-3.10+-blue.svg)](https://www.python.org/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-12+-blue.svg)](https://www.postgresql.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

## Описание проекта

Система состоит из следующих компонентов:

- **Модели данных** (`models/`) - сущности User, Table, Booking
- **Драйвер БД** (`postgres_driver.py`) - универсальный менеджер для работы с PostgreSQL
- **Backend API** (`backend.py`) - CRUD операции и бизнес-логика
- **GUI приложение** (`frontend_gui.py`) - графический интерфейс на tkinter

## Требования

- Python 3.10+
- PostgreSQL (версия 12+)
- tkinter (обычно входит в стандартную установку Python)

## Установка и настройка

### 1. Клонирование/копирование проекта

```bash
cd /path/to/project
```

### 2. Создание виртуального окружения

```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

### 3. Установка зависимостей

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

Зависимости:
- `psycopg2-binary` - драйвер PostgreSQL
- `python-dotenv` - загрузка переменных окружения

### 4. Настройка базы данных

#### 4.1. Создание базы данных PostgreSQL

Убедитесь, что PostgreSQL установлен и запущен:

```bash
# Проверка статуса PostgreSQL
sudo systemctl status postgresql  # Linux
# или
brew services list  # Mac (если установлен через Homebrew)
```

Создайте базу данных (если еще не создана):

```bash
sudo -u postgres psql
CREATE DATABASE booking_system;
\q
```

#### 4.2. Настройка переменных окружения

Скопируйте файл `env.example` в `.env`:

```bash
cp env.example .env
```

Отредактируйте файл `.env` и укажите параметры подключения к вашей базе данных:

```env
DB_HOST=localhost
DB_PORT=5432
DB_NAME=booking_system  # или postgres, если используете стандартную БД
DB_USER=postgres
DB_PASSWORD=your_password
```

**Важно:** Замените `your_password` на реальный пароль пользователя PostgreSQL.

## Создание таблиц в базе данных

Перед первым запуском приложения необходимо создать таблицы в базе данных.

### Автоматическое создание таблиц

Запустите скрипт инициализации:

```bash
python init_db.py
```

Этот скрипт:
- Подключается к базе данных используя настройки из `.env`
- Создает таблицы для всех сущностей:
  - `user` - пользователи системы
  - `restaurant_table` - столы в ресторане
  - `booking` - бронирования

### Пересоздание таблиц

Если нужно пересоздать таблицы (удалить существующие и создать заново):

```bash
python init_db.py --drop
```

**Внимание:** При использовании флага `--drop` все существующие данные будут удалены!

### Проверка структуры таблиц

Для проверки созданных таблиц используйте:

```bash
python check_tables.py
```

Скрипт выведет структуру всех таблиц с типами данных и ограничениями.

## Заполнение базы данных тестовыми данными

После создания таблиц можно заполнить базу тестовыми данными для удобства тестирования.

### Заполнение тестовыми данными

```bash
python seed_data.py
```

Скрипт создаст:
- **4 пользователя** с разными именами, телефонами и email
- **5 столов** с различными характеристиками (номер, вместимость, локация)
- **3 бронирования** на разные даты и время

### Очистка и повторное заполнение

Для очистки существующих данных и заполнения заново:

```bash
python seed_data.py --clear
```

**Внимание:** При использовании флага `--clear` все существующие данные будут удалены перед заполнением!

### Просмотр данных

Для просмотра созданных данных:

```bash
python check_data.py
```

Скрипт выведет список всех пользователей, столов и бронирований.

## Запуск приложения

После настройки базы данных и создания таблиц можно запустить GUI приложение:

```bash
python main.py
```

Приложение откроется в отдельном окне с тремя вкладками:
- **Пользователи** - управление пользователями
- **Столы** - управление столами
- **Бронирования** - управление бронированиями

## Работа с GUI

### Вкладка "Пользователи"

#### Создание пользователя:
1. Заполните поля формы:
   - **Имя** - имя пользователя (должно быть уникальным)
   - **Телефон** - номер телефона (например, +79001234567)
   - **Email** - электронная почта
2. Нажмите кнопку **"Создать"**

**Важно:** Имя пользователя должно быть уникальным. Система автоматически проверяет уникальность имени при создании. Если пользователь с таким именем уже существует, появится сообщение об ошибке.

#### Редактирование пользователя:
1. Дважды кликните на пользователе в списке справа
2. Данные загрузятся в форму слева
3. Измените нужные поля
4. Нажмите кнопку **"Обновить"**

**Примечание:** При изменении имени система проверяет его уникальность. Нельзя изменить имя на уже существующее (кроме случая, когда имя не изменяется).

#### Удаление пользователя:
1. Выберите пользователя в списке (один клик)
2. Нажмите кнопку **"Удалить"**
3. Подтвердите удаление

#### Обновление списка:
- Нажмите кнопку **"Обновить"** для обновления списка пользователей
- Список автоматически обновляется после создания/обновления/удаления

### Вкладка "Столы"

#### Создание стола:
1. Заполните поля формы:
   - **Номер** - номер стола (целое число, должен быть уникальным)
   - **Вместимость** - количество мест (целое число)
   - **Локация** - выберите из списка: `window`, `corner`, `center`
   - **Доступен** - отметьте галочку, если стол доступен для бронирования
2. Нажмите кнопку **"Создать"**

**Важно:** Номер стола должен быть уникальным. Система автоматически проверяет уникальность номера при создании. Если стол с таким номером уже существует, появится сообщение об ошибке.

#### Редактирование стола:
1. Дважды кликните на столе в списке справа
2. Данные загрузятся в форму слева
3. Измените нужные поля
4. Нажмите кнопку **"Обновить"**

**Примечание:** При изменении номера система проверяет его уникальность. Нельзя изменить номер на уже существующий (кроме случая, когда номер не изменяется).

#### Удаление стола:
1. Выберите стол в списке (один клик)
2. Нажмите кнопку **"Удалить"**
3. Подтвердите удаление

### Вкладка "Бронирования"

#### Проверка доступности стола:

**Важно:** Перед созданием бронирования рекомендуется проверить доступность стола!

1. Выберите **Стол** из выпадающего списка (отображаются номера столов)
2. Укажите **Дату** (формат: YYYY-MM-DD, например: 2026-01-15)
3. Укажите **Время** (формат: HH:MM, например: 19:30)
4. Укажите **Длительность** в минутах (по умолчанию 120)
5. Нажмите кнопку **"Проверить доступность"**

Система проверит:
- Существует ли стол
- Доступен ли стол для бронирования
- Нет ли пересекающихся бронирований на указанное время

**Результат проверки:**
- Если стол доступен - появится сообщение "Стол доступен на указанное время!"
- Если стол недоступен - появится сообщение с причиной (например, "Стол уже забронирован с 17.01.2026 20:52 до 22:52")

#### Показать доступные столы:

Эта функция позволяет увидеть все доступные столы на указанное время без необходимости выбирать конкретный стол.

1. Укажите **Дату** (формат: YYYY-MM-DD, например: 2026-01-15)
2. Укажите **Время** (формат: HH:MM, например: 19:30)
3. Укажите **Длительность** в минутах (по умолчанию 120)
4. Нажмите кнопку **"Показать доступные столы"**

**Результат:**
- Откроется новое окно со списком всех доступных столов на указанное время
- В списке отображаются: **Номер стола**, **Вместимость**, **Локация**
- Столы отсортированы по номеру
- Показываются только столы, которые доступны и не имеют пересекающихся бронирований

**Примечание:** Если дата и время не указаны, появится предупреждение.

#### Создание бронирования:
1. Выберите **Пользователя** из выпадающего списка (отображаются имена пользователей)
2. Выберите **Стол** из выпадающего списка (отображаются номера столов)
3. Укажите **Дату и время** бронирования
4. Укажите **Количество гостей** (целое число)
5. Укажите **Длительность** в минутах (по умолчанию 120)
6. Выберите **Статус** из списка: `pending`, `confirmed`, `cancelled`
7. При необходимости укажите **Пожелания** в текстовом поле
8. (Рекомендуется) Нажмите **"Проверить доступность"** перед созданием
9. Нажмите кнопку **"Создать"**

**Примечания:**
- Система автоматически проверяет доступность при создании бронирования. Если стол недоступен, бронирование не будет создано и появится сообщение об ошибке.
- При выборе пользователя отображаются только имена (без ID). Система автоматически находит `user_id` по имени пользователя при создании бронирования.
- При выборе стола отображаются только номера (без ID). Система автоматически находит `table_id` по номеру стола при создании бронирования.
- Если выбранный пользователь или стол не найден, появится сообщение об ошибке.

#### Редактирование бронирования:
1. Дважды кликните на бронировании в списке справа
2. Данные загрузятся в форму слева (в поле "Пользователь" будет отображаться имя пользователя, в поле "Стол" - номер стола)
3. Измените нужные поля
4. (Рекомендуется) Нажмите **"Проверить доступность"** или **"Показать доступные столы"** перед обновлением
5. Нажмите кнопку **"Обновить"**

**Примечания:**
- При изменении времени или стола система автоматически проверяет доступность, исключая само редактируемое бронирование из проверки.
- При изменении пользователя выберите имя из выпадающего списка. Система автоматически найдет `user_id` по имени.
- При изменении стола выберите номер из выпадающего списка. Система автоматически найдет `table_id` по номеру.

#### Отображение списков:

**Список пользователей:**
- Отображаются колонки: Имя, Телефон, Email, Создан
- Колонка ID скрыта для удобства

**Список столов:**
- Отображаются колонки: Номер, Вместимость, Локация, Доступен
- Колонка ID скрыта для удобства

**Список бронирований:**
- Отображаются колонки: Стол, Локация, Пользователь, Дата, Гостей, Статус
- Колонка "Стол" отображается первой для удобства
- Колонка "Локация" показывает локацию стола (window, corner, center)
- Колонка ID скрыта для удобства

#### Подтверждение бронирования:
1. Выберите бронирование в списке (один клик)
2. Нажмите кнопку **"Подтвердить"**
3. Статус бронирования изменится на `confirmed`

#### Отмена бронирования:
1. Выберите бронирование в списке (один клик)
2. Нажмите кнопку **"Отменить"**
3. Подтвердите отмену
4. Статус бронирования изменится на `cancelled`

**Примечание:** Отмененные бронирования не учитываются при проверке доступности стола.

#### Удаление бронирования:
1. Выберите бронирование в списке (один клик)
2. Нажмите кнопку **"Удалить"**
3. Подтвердите удаление

## Структура проекта

```
booking_table_GUI/
├── models/                 # Модели данных
│   ├── __init__.py
│   └── models.py           # Классы User, Table, Booking
├── postgres_driver.py      # Универсальный драйвер для PostgreSQL
├── backend.py              # Backend API с CRUD операциями
├── frontend_gui.py          # GUI приложение на tkinter
├── main.py                 # Точка входа для запуска приложения
├── init_db.py              # Скрипт создания таблиц
├── seed_data.py            # Скрипт заполнения тестовыми данными
├── check_tables.py         # Скрипт проверки структуры таблиц
├── check_data.py           # Скрипт просмотра данных
├── test_backend.py         # Тесты backend API
├── test_availability.py    # Тесты проверки доступности
├── test_user_name.py       # Тесты работы с именами пользователей
├── requirements.txt        # Зависимости проекта
├── env.example             # Пример файла с переменными окружения
├── .env                    # Файл с настройками БД (создается вручную)
└── README.md               # Документация
```

## Дополнительные скрипты

### Проверка структуры таблиц

```bash
python check_tables.py
```

Выводит структуру всех таблиц с типами данных, ограничениями и значениями по умолчанию.

### Просмотр данных

```bash
python check_data.py
```

Выводит список всех пользователей, столов и бронирований в удобном формате.

### Тестирование Backend API

```bash
python test_backend.py
```

Запускает тесты всех CRUD операций для всех сущностей.

### Тестирование проверки доступности

```bash
python test_availability.py
```

Запускает тесты функции проверки доступности стола, включая проверку пересечений бронирований.

### Тестирование работы с именами пользователей

```bash
python test_user_name.py
```

Запускает тесты проверки уникальности имен пользователей и поиска пользователей по имени.

## Особенности системы

### Уникальность имен пользователей и номеров столов

Система обеспечивает уникальность имен пользователей и номеров столов:

**Пользователи:**
- При создании пользователя проверяется, не существует ли уже пользователь с таким именем
- При обновлении пользователя проверяется уникальность нового имени (если имя изменяется)
- Если попытка создать или обновить пользователя с существующим именем, система выдаст ошибку
- Имена пользователей используются для выбора при создании бронирований (вместо ID)

**Столы:**
- При создании стола проверяется, не существует ли уже стол с таким номером
- При обновлении стола проверяется уникальность нового номера (если номер изменяется)
- Если попытка создать или обновить стол с существующим номером, система выдаст ошибку
- Номера столов используются для выбора при создании бронирований (вместо ID)

### Работа с пользователями и столами при бронировании

**Пользователи:**
- В форме бронирования пользователь выбирается по имени из выпадающего списка
- Система автоматически находит `user_id` по имени пользователя
- Это упрощает работу с системой - не нужно помнить ID пользователей

**Столы:**
- В форме бронирования стол выбирается по номеру из выпадающего списка
- Система автоматически находит `table_id` по номеру стола
- Это упрощает работу с системой - не нужно помнить ID столов

### Проверка доступности стола

Система автоматически предотвращает создание пересекающихся бронирований:

- Проверяет пересечение временных интервалов
- Учитывает только активные бронирования (`pending` и `confirmed`)
- Игнорирует отмененные бронирования (`cancelled`)
- При обновлении бронирования исключает его из проверки

### Типы данных

- **UUID** - используется для всех идентификаторов
- **datetime** - для дат и времени
- **VARCHAR** - для строковых данных
- **INTEGER** - для числовых данных
- **BOOLEAN** - для флагов доступности

### Обработка ошибок

Система обрабатывает следующие ошибки:
- Ошибки подключения к базе данных
- Ошибки валидации данных
- Ошибки при создании пересекающихся бронирований
- Ошибки при работе с несуществующими записями

Все ошибки отображаются пользователю через диалоговые окна.

## Решение проблем

### Ошибка подключения к базе данных

1. Проверьте, что PostgreSQL запущен:
   ```bash
   sudo systemctl status postgresql
   ```

2. Проверьте настройки в файле `.env`

3. Проверьте, что база данных существует:
   ```bash
   sudo -u postgres psql -l
   ```

4. Проверьте права доступа пользователя к базе данных

### Ошибка "Стол недоступен"

- Убедитесь, что стол существует и помечен как доступный
- Проверьте, нет ли пересекающихся бронирований
- Используйте кнопку "Проверить доступность" для получения подробной информации

### Ошибка при создании таблиц

- Убедитесь, что база данных существует
- Проверьте права пользователя на создание таблиц
- Попробуйте пересоздать таблицы с флагом `--drop`

## Лицензия

Проект распространяется под лицензией MIT. См. файл [LICENSE](LICENSE) для подробностей.

## Автор

Система разработана для управления бронированием столов администратором в ресторане.

